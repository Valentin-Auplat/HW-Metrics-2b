---
title: "Homework Metrics 2b: Federal Reserve's interest rates and global outstanding credit. A univariate and multivariates analysis"
author: "Valentin Auplat, Nino Laffray"
date: "May 2025"
output:
  pdf_document: default
  html_document:
    df_print: paged
---
```{r}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)
```

```{r echo = FALSE, message = FALSE, warning = FALSE}
library(haven)
library(dplyr)
library(knitr)
library(tidyr)
library(ggplot2)
library(stargazer)
library(Synth)
library(foreign)
library(knitr)
library(readxl)
library(purrr)
library(janitor)
library(lubridate)
library(tsibble)
```

```{r, echo = FALSE}
flatten_countries <- function(file_path) {
  # Read the sheet and skip the header row
  df <- read_excel(file_path, sheet = 3, skip = 1)

  # Rename first column
  colnames(df)[1] <- "Category"
  df <- df[c(1:20),]
  # Tag levels based on pattern rules
  df <- df %>%
    mutate(
      Level0 = ifelse(grepl("Borrowers outside", Category), Category, NA),
      Level1 = ifelse(grepl("^Of which:", Category), Category, NA),
      Level2 = ifelse(grepl("^Africa and Middle East|^Emerging Asia and Pacific|^Emerging Europe|^Latin America", Category), Category, NA),
      Level3 = ifelse(is.na(Level0) & is.na(Level1), Category, NA)
    ) %>%
    fill(Level0, Level1, Level2, .direction = "down") %>%
    select(Level0, Level1, Level2, everything())  # Keep hierarchy + data
  
  return(df)
}


flatten_instruments <- function(file_path) {
  dt <- read_excel(file_path, sheet = 3, skip = 1)
  colnames(dt)[1] <- "Category"
  dt <- dt[21:32, ]  # Adjust to the actual instrument section

  dt <- dt %>%
    mutate(
      Level0 = ifelse(grepl("By instrument|Memo: Borrowers in United States", Category), Category, NA),
      Level1 = ifelse(grepl("Borrowers outside United States|Of which: emerging market and developing economies|Non-financial borrowers", Category), Category, NA),
      Level2 = ifelse(grepl("Bank loans|Debt securities issues|Of which: government|Of which: emerging market and developing economies", Category), Category, NA)) %>%
    fill(Level0, Level1, Level2, .direction = "down") %>%
    select(Level0, Level1, Level2 , everything())
dt <- dt[-c(1,10),]
  return(dt)
}
data <- flatten_instruments("2.xlsx")
```

```{r, echo = FALSE}
merged_data_countries <- flatten_countries("2.xlsx")
for (i in 3:34){
  data <- flatten_countries(paste0(i, ".xlsx"))
  merged_data_countries <- merge(merged_data_countries, data, by = c("Level0", "Level1", "Level2", "Level3", "Category"))
}
merged_data_countries <- merged_data_countries %>% 
  clean_names() %>%
  select(-matches("(_5|_6|_7)")) %>%
  rename_with(~ sub("^x", "", .x)) %>%
  rename_with(~ sub("(_2$|_3$|_4$)", "", .x))

merged_data_instruments <- flatten_instruments("2.xlsx")
for (i in 3:34){
  data <- flatten_instruments(paste0(i, ".xlsx"))
  merged_data_instruments <- merge(merged_data_instruments, data, by =  c("Level0", "Level1", "Level2", "Category"), all.x = TRUE)
}
merged_data_instruments <- merged_data_instruments %>% 
  clean_names() %>%
  select(-matches("(_5|_6|_7)")) %>%
  rename_with(~ sub("^x", "", .x)) %>%
  rename_with(~ sub("(_2$|_3$|_4$)", "", .x))

df_long <- merged_data_countries %>%
  select(-level0, -level1, -level2, -level3) %>%
  pivot_longer(
    cols = -category, # all columns except 'category'
    names_to = "quarter",
    values_to = "value"
  ) %>%
  arrange(category, quarter)

FED <- read.csv("FEDFUNDS.csv")
FED <- FED %>%
  mutate(
    observation_date = ymd(observation_date),
    quarter = quarter(observation_date),
    year = year(observation_date),
    observation_date = paste0(year, "-q", quarter)
  ) %>%
  select(-year, -quarter)
FED <- FED %>%
  rename(value = FEDFUNDS) %>%
  rename(quarter = observation_date) %>%
  mutate(category = "FED_rate")
FED <- FED %>%
    mutate(quarter = gsub("-", "_", FED$quarter))

df_long <- rbind(df_long, FED) %>%
  filter(quarter >= "2000-q1") %>%
  filter(quarter <= "2023-q4") %>%
  pivot_wider(names_from = category, values_from = value)
```

```{r, echo = FALSE}
df_long <- ts(df_long, start=c(2000, 1), frequency=4)
plot(df_long[, "FED_rate"])
plot(df_long[,c("Emerging Asia and Pacific", "Emerging Europe", "Latin America")], plot.type="s", col=c("red","green", "blue"))
legend("topleft", legend=c("Emerging Asia and Pacific","Emerging Europe", "Latin America") ,col=c("red","green", "blue"), lty=1, bty="n") # add legend
```
```{r}
library(urca)
library(zoo)
library(forecast)
df_long <- ts(df_long, start=c(2000, 1), end=c(2020, 1), frequency=4)
# 2.1 ADF Test (Augmented Dickey-Fuller)
adf_test <- ur.df(df_long[,c("FED_rate")], type = "trend", lags = 2)  # Try "drift" or "none" too
summary(adf_test)
```
Although the visual plot of the FED rate shows distinct level shifts and prolonged flat regimes (e.g., 2008â€“2016), the ADF test result shows that the process is stationary once we control for trend and include appropriate lags.

This means the visual "non-stationarity" may be deterministic trend or policy-driven shifts, but not a stochastic unit root.


```{r}
# 2.1 ADF Test (Augmented Dickey-Fuller)
adf_test <- ur.df(df_long[,c("Borrowers outside United States")], type = "trend", lags = 4)  # Try "drift" or "none" too
summary(adf_test)
```
Idem.


```{r}
# 2.2 PP Test (Phillips-Perron)
pp_test <- ur.pp(df_long[,c("FED_rate")], type = "Z-tau", model = "trend", lags = "short")
summary(pp_test)

# 2.3 KPSS Test (Stationarity)
kpss_test <- ur.kpss(df_long[,c("FED_rate")], type = "tau", lags = "short")
summary(kpss_test)
```